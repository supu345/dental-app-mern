;/*FB_PKG_DELIM*/

__d("EBDB",["$InternalEnum","I64","Promise","WALogger","WALongInt","WAPREList","WAPREMetrics","Worm","WormEAR","WormIDbDriver","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error performing makeEBDB: ",""]);j=function(){return a};return a}var k=b("$InternalEnum")({UI:0,Worker:1}),l={device_state:{primaryKey:"env",secure:!0}},m,n=1e4;function a(a,b){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.EBDB_INIT,{string:{operationType:"initEBDB"}},void 0,n);try{b=new(d("WormEAR").WormEAR)(l,b);a=new(d("Worm").WormDatabase)(new(d("WormIDbDriver").WormIDbDriver)(a,l,b,{onTransactionError:function(a){if(a instanceof d("WormEAR").DecryptionError){a=a;if(a.store==="device_state"){r();return}}},safeToDeleteStores:new Set(["auto_restore_opt_out","device_metadata","encrypted_backups","encrypted_backups_virtual_devices","experiences_shared_state","secure_encrypted_backups_client_state","secure_encrypted_backups_epochs","secure_encrypted_backups_recovery_code_status"])}));m=a;yield a.init({eventFlow:c});c.endSuccess();return a}catch(a){c.endFail("error");d("WALogger").ERROR(j(),a);throw a}});return o.apply(this,arguments)}function p(){if(m==null)throw c("err")("EBDB is not initialized");return m}function e(a){var b={};for(a of Object.entries(a)){var c=a[0],d=a[1];if(d==null)continue;else b[c]=q(d)}return b}function q(a){if((i||(i=d("I64"))).isI64(a))return d("WALongInt").decimalStringToLongInt((i||(i=d("I64"))).to_string(a));else return a}function r(){if(m==null)return;m.runInTransaction(["device_state"],"readwrite",function(a){return a.stores.device_state.clear()},"EBDB - clearDeviceState")["catch"](function(){})}function f(){var a=Object.keys(l);return p().runInTransaction(a,"readonly",function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){var d={};yield (h||(h=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield c.stores[a].readAll());d[a]=b});return function(b){return a.apply(this,arguments)}}()));return d});return function(a){return c.apply(this,arguments)}}(),"EBDB - Dump")["catch"](function(){return{}})}g.StateHistoryEnvironment=k;g.ebdbDescriptor=l;g.makeEBDB=a;g.getEBDB=p;g.mapI64ToLongInt=e;g.i64ToLongInt=q;g.getDbDump=f}),98);
__d("EBTrackDeviceRegistration",["EBDB","FBLogger","QPLUserFlow","ReQL","WATagsLogger","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EBDB error: fetching device_state: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["EBLS error on fetching data from encrypted_backups: ",""]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS(["EBDeviceState"]),k=null;function a(){return k}function l(a,b,c,d){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,h){var i=d("EBDB").i64ToLongInt(g);g=!1;try{yield a.runInTransaction(["device_state"],"readwrite",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield a.stores.device_state.get(e));b!=null&&(g=!0);i!=null&&(yield a.stores.device_state.bulkPut([{deviceId:i,env:e}]))});return function(b){return a.apply(this,arguments)}}(),"EBDB - AddDevice",f.id+":45"),h!=null&&c("QPLUserFlow").addAnnotations(h,{bool:{overprompting:g}}),i!=null&&(k=i)}catch(a){c("FBLogger")("labyrinth_web").catching(a).mustfix("Error on EBDB - AddDevice")}});return m.apply(this,arguments)}function e(a,b,c,d,e){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g){if(!c("gkx")("7413"))return;if(f!=null)return l(b,e,f,g);try{f=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_client_state)));return l(b,e,f==null?void 0:f.deviceId,g)}catch(a){c("FBLogger")("labyrinth_web").catching(a).mustfix("Error on fetching secure_encrypted_backups_client_state")}});return n.apply(this,arguments)}function o(a){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield a.runInTransaction(["device_state"],"readwrite",function(a){return a.stores.device_state.clear()},"EBDB - clearDeviceState",f.id+":107"),k=null});return p.apply(this,arguments)}var q;function r(a,b,c){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){if(!c("gkx")("7413"))return;q!=null&&q();yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups)).then(function(a){a!=null&&((a==null?void 0:a.backupId)==null||(a==null?void 0:a.isUserOptedOut)===!0)&&void o(b)})["catch"](function(a){j.ERROR(i(),a)});q=a.tables.encrypted_backups.subscribe(function(a,c){c.operation!=="delete"&&((c.value.backupId==null||c.value.isUserOptedOut===!0)&&void o(b))});a=(yield b.runInTransaction(["device_state"],"readonly",function(a){return a.stores.device_state.get(e)},"EBDB - readDeviceState",f.id+":158")["catch"](function(a){j.ERROR(h(),a)}));k=a==null?void 0:a.deviceId});return s.apply(this,arguments)}g.getDeviceId=a;g.trackAddingDevice=e;g.clearState=o;g.startListeningDeviceRegistrations=r}),98);
__d("EBTrackDeviceRegistrationUI",["EBDB","EBTrackDeviceRegistration","FBLogger","LSDatabaseSingleton","MAWCurrentUser","MAWIndexedDbMetadata","MessengerWebInitData","WAHex","WAPREMetrics","WAResolvable","asyncToGeneratorRuntime","maybeSetupMAWMainThreadLogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new(d("WAResolvable").Resolvable)();function a(){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;try{d("WAPREMetrics").subscribe(function(){}),d("maybeSetupMAWMainThreadLogger").maybeSetupMAWMainThreadLogger(),yield d("EBDB").makeEBDB(d("MAWIndexedDbMetadata").ebdbName(d("MAWCurrentUser").getID()),d("WAHex").parseHex(c("MessengerWebInitData").accountKeyV2)),a=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton),yield d("EBTrackDeviceRegistration").startListeningDeviceRegistrations(a,d("EBDB").getEBDB(),d("EBDB").StateHistoryEnvironment.UI)}catch(a){c("FBLogger")("labyrinth_web").catching(a).mustfix("Error on EBDB init in UI")}finally{i.resolve(a)}});return j.apply(this,arguments)}function e(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=(yield i.promise);if(c==null)return;yield d("EBTrackDeviceRegistration").trackAddingDevice(c,d("EBDB").getEBDB(),d("EBDB").StateHistoryEnvironment.UI,b,a)});return k.apply(this,arguments)}function f(){return d("EBDB").getDbDump()}function l(){return d("EBDB").getEBDB()}g.initEBDB=a;g.trackAddingDevice=e;g.getEBDBDump=f;g.getEBDBInstance=l}),98);
__d("createErrorForMAIBALogger",["err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a instanceof Error)return a;else try{return c("err")((a=JSON.stringify(a))!=null?a:"Unknown error")}catch(a){return c("err")("Unknown error")}}g["default"]=a}),98);