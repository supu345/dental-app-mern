;/*FB_PKG_DELIM*/

__d("CryptoUtils",["Base64Utils","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","MEBEncryptionVersion","SymmetricEncryptionPaddingUtils","XPlatReactCrypto","XPlatReactTextDecoder","err"],(function(a,b,c,d,e,f,g){"use strict";var h=32,i=2147483647,j="message_key_in_epoch",k="_",l="cipher_version",m="thread";e="message_thread";function a(a,b,d,e){var f=d>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?null:n(e);a=o(a,d,e);if(a==null)throw c("err")("Error in derive message symmetric key. info is null");return q(a,f,b,[h])}function n(a){try{return new TextEncoder().encode(a).buffer}catch(a){throw c("err")("Error in get blob from string with exception: ",a)}}function o(a,b,c){a=p(a,b,c);return n(a)}function p(a,b,e){if(b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY||b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT)return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a),l,b,m,e!=null?e:""].join(k);else if(b>=c("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION)return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a),l,b].join(k);else return[j,new(d("XPlatReactTextDecoder").TextDecoder)().decode(a)].join(k)}function q(a,b,e,f){if(f.length<1||f.some(function(a){return a>i}))throw c("err")("Invalid key lengths for derive keys");var g=f.reduce(function(a,b){return a+b},0)*8;return d("XPlatReactCrypto").subtleImportKey("raw",e,"HKDF",!1,["deriveBits"]).then(function(c){var e;return d("XPlatReactCrypto").subtleDeriveBits({hash:"SHA-256",info:a,name:"HKDF",salt:(e=b)!=null?e:new Uint8Array(10).buffer},c,g)}).then(function(a){a=new Uint8Array(a);var b=[],c=0;for(var d=0,e=f.length;d<e;++d){var g=c+f[d];b.push(a.slice(c,g).buffer);c=g}return b})["catch"](function(a){throw c("err")("Exception in create derived keys",a)})}function b(a,b,e){e=d("Base64Utils").toArrayBuffer(e);return r(a,b,e).then(function(a){return a}).then(function(a){if(a==null)throw c("err")("symmetric string decryption with null result");return new(d("XPlatReactTextDecoder").TextDecoder)().decode(a)})["catch"](function(a){throw c("err")("symmetric string decryption failed with error",a)})}function r(a,b,e){if(e.byteLength<d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)throw c("err")("cipher text is invalid");e=new Uint8Array(e);var f=e.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),g=new(d("HChaCha20").HChaCha20)(),h=e.slice(d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer;e=g.hChaCha20Bytes(f.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,a);return d("XPlatReactCrypto").subtleImportKey("raw",e,"AES-GCM",!1,["decrypt"]).then(function(a){return d("XPlatReactCrypto").subtleDecrypt({additionalData:b,iv:new Uint8Array(f.slice(d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},a,h)}).then(function(a){a=d("SymmetricEncryptionPaddingUtils").stripPadding(a);if(a==null)throw c("err")("Failed to strip padding for symmetric decryption");return a})["catch"](function(a){throw c("err")("symmetric data decryption failed with error",a)})}g.KEY_LEN=h;g.MAX_INT_32=i;g.STRING_JOIN_SEPARATOR=k;g.MESSAGE_ENCYPTION_AAD=e;g.deriveMessageSymmetricKey=a;g.getBlobFromString=n;g.createDerivedKeys=q;g.symmetricEncryptionCreateDecryptedString=b}),98);
__d("EBAPISharedUtils",["EBAPIQPLPoints","I64","LSAuthorityLevel","LSDeleteAndReenrollDeviceStateStoredProcedure","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","MAWBridgeSafeActionsWorkerAndUI","MWEBODSEntityName.enum","ODS","WALogger","asyncToGeneratorRuntime","handleRestoreMessagesGraphQLResponse"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Echo to protobuf conversion failed in search range restore response: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backup_id is null during graphQL restore"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is not complete - cannot proceed with graphQL restore"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is null - cannot proceed with graphQL restore"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] server side exception during graphql restore - ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] GQL worker range restore query returned null for message response"]);p=function(){return a};return a}function a(a,b){if(a!=null){b=b.filter(function(a){return(h||(h=d("I64"))).equal(a.authorityLevel,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))}).map(function(a){return(h||(h=d("I64"))).to_string(a.epochId)});return{backupId:a.backupId,device_id:a.deviceId,locally_available_epochs:b,mailboxRootKey:a.mailboxRootKeyBlob,ocmfClientStateBlob:a.ocmfClientStateBlob}}}function e(a){var b=a==null?void 0:a.backupTenancy;a=a==null?void 0:a.authorityLevel;return b==null||a==null?!1:(h||(h=d("I64"))).equal((i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE),a)}function q(a){var b=a.backupId,c=a.devicePrivateKeyBlob,d=a.devicePublicKeyBlob,e=a.epochAuthPrivateKeyBlob,f=a.epochAuthPublicKeyBlob,g=a.epochStoragePrivateKeyBlob,h=a.epochStoragePublicKeyBlob,i=a.mailboxRootKeyBlob,j=a.obliviousValidationTokenBlob,k=a.ocmfClientStateBlob;if(b!=null&&c!=null&&d!=null&&e!=null&&f!=null&&g!=null&&h!=null&&i!=null&&j!=null&&k!=null)return{authorityLevel:a.authorityLevel,backupId:b,backupTenancy:a.backupTenancy,deviceId:a.deviceId,devicePrivateKeyBlob:c,devicePublicKeyBlob:d,encryptionVersion:a.encryptionVersion,epochAuthPrivateKeyBlob:e,epochAuthPublicKeyBlob:f,epochStoragePrivateKeyBlob:g,epochStoragePublicKeyBlob:h,mailboxRootKeyBlob:i,obliviousValidationTokenBlob:j,ocmfClientStateBlob:k,revisionVersion:a.revisionVersion}}function r(a){var b=a.authorityLevel,c=a.backupId,d=a.epochAnonIdBlob,e=a.epochId,f=a.epochRootKeyBlob;a=a.epochStatus;if(b!=null&&c!=null&&d!=null&&e!=null&&f!=null&&a!=null)return{authorityLevel:b,backupId:c,epochAnonIdBlob:d,epochId:e,epochRootKeyBlob:f,epochStatus:a}}function s(a){var b=[],c=new Set(["epochId","authorityLevel","backupId","epochAnonIdBlob","epochRootKeyBlob","epochStatus"]);a=a.get("secure_encrypted_backups_epochs");if(a==null||(a==null?void 0:a.size)===0)return b;if(a!=null){a=a.entries();for(a of a){var d=a[0];a[1];d=d;if(d instanceof Object){d=Object.values(d);d=d[1];if(d instanceof Object){var e={};for(d of Object.entries(d)){var f=d[0],g=d[1];c.has(f)&&(e[f]=g)}f=r(e);f!=null&&b.push(f)}}}}return b}function t(a){a=a.get("secure_encrypted_backups_client_state");var b={};if(a==null||(a==null?void 0:a.size)===0)return;if(a!=null){a=a.entries();for(a of a){var c=a[0];a[1];c=c;if(c instanceof Object){c=Object.values(c);c=c[1];if(c instanceof Object)for(c of Object.entries(c)){var d=c[0],e=c[1];b[d]=e}}break}}d=q(b);return d}function u(a){(j||(j=d("ODS"))).bumpEntityKey(7319,c("MWEBODSEntityName.enum").MAW_EB_RESTORE_COUNTER,a)}function v(a,b,c,d,e,f,g,h,i,j,k,l){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,g,j,q,r,s,t,u,v,w){var x;d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,void 0,j);if(a==null||(a==null?void 0:(x=a.viewer)==null?void 0:(x=x.encrypted_backup)==null?void 0:x.mailbox)==null){d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,j);return{response:"invalid-graphql-response",success:!1}}a=(x=a==null?void 0:(x=a.viewer)==null?void 0:(x=x.encrypted_backup)==null?void 0:(x=x.mailbox)==null?void 0:x.messages)!=null?x:a==null?void 0:(x=a.viewer)==null?void 0:(a=x.encrypted_backup)==null?void 0:(x=a.mailbox)==null?void 0:x.messages_point_restore;if(a==null){d("WALogger").ERROR(p());d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,j);return{response:"invalid-graphql-response",success:!1}}x=a;if((x==null?void 0:x.encrypted_messages)==null){d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,j);return{response:"invalid-graphql-response",success:!1}}a=x.backup_id;var y=x.encrypted_messages,z=x.epoch_derivation_set,A=x.exception_string,B=x.message_range_info;x=x.should_delete_mailbox;if(A!=null){d("WALogger").ERROR(o(),A);x===!0&&(d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,void 0,j),yield g.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(i||(i=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:q})},"readwrite",void 0,void 0,f.id+":335"));d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,j,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:A}});return{response:"server-side-exception",success:!1}}d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,void 0,j);yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(z,g,q,u,b);d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,void 0,j);if(B==null){d("WALogger").ERROR(n());d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,j);return{response:"missing-message-range-info",success:!1}}if(B!=null){x=B.has_more_after;A=B.has_more_before;z=B.next_message_timestamp_ms_after;var C=B.next_message_timestamp_ms_before;if(A==null||x==null||z==null||C==null){d("WALogger").ERROR(m());d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,j);return{response:"missing-message-range-info",success:!1}}}a==null&&(d("WALogger").WARN(l()),d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,void 0,j));d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_START,void 0,j);A=(yield d("handleRestoreMessagesGraphQLResponse").processEncryptedMessagesWithoutPersisting({backupId:a!=null?a:(h||(h=d("I64"))).to_string(w),encryptedMessages:y,messageRangeInfo:B,qplEvent:e,runningInWorker:b,sortOrderMs:v,source:t,storage:g,threadId:r,traceId:u}));d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_END,void 0,j);if(A==null){d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EMPTY_DECRYPTION_RESPONSE,j);return{response:"empty-decryption-response",success:!1}}if(A.echoMessages!=null){x=A;z=x.echoMessages;d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_TO_PROTOBUF_CONVERSION_START,void 0,j);try{C=(yield d("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("convertEchoMessagesToEBProtobufs",{chatJid:s,encodedEchoMessages:z}));d("EBAPIQPLPoints").ebAPIAddQPLPoint(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_TO_PROTOBUF_CONVERSION_END,void 0,j);A=babelHelpers["extends"]({},A,{echoMessages:void 0,protobufMessages:(A.protobufMessages||[]).concat(C)})}catch(a){d("WALogger").ERROR(k(),a.message);d("EBAPIQPLPoints").ebAPIEndFailure(b,e,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_TO_PROTOBUF_CONVERSION_FAILURE,j);return{response:"echo-to-protobuf-conversion-error",success:!1}}}d("EBAPIQPLPoints").ebAPIEndSuccess(b,e,j,{bool:{isEcho:((a=A)==null?void 0:a.echoMessages)?((w=A)==null?void 0:w.echoMessages.length)>0:!1,isProtobuf:((y=A)==null?void 0:y.protobufMessages)?((B=A)==null?void 0:B.protobufMessages.length)>0:!1}});return{response:A,success:!0}});return w.apply(this,arguments)}g.getDeviceAndKeyMetadata=a;g.isBackupTenancyAuthoritative=e;g.getAvailableEpochsFromPersistedEBSM=s;g.getClientStateFromPersistedEBSM=t;g.bumpOdsRestoreKey=u;g.constructEBRestoreResponse=v}),98);
__d("EBMessagePointQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9664280036967963"}),null);
__d("EBMessagePointQueryWithPersistenceQuery.graphql",["EBMessagePointQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessagePointQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessagePointQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessagePointQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessagePointQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBMessagePointQueryWithPersistence",["EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBIsEbEnabled","EBMessagePointQueryWithPersistenceQuery.graphql","EBSMHydrationUtils","I64","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSDeleteAndReenrollDeviceStateStoredProcedure","LSEncryptedBackupsBackupTenancy","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","LSMEBTaskCreationSource","LSShape","LSVec","MAWBridge","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsPersistedDB","MAWJobDefinitions","MAWMainTraceUtils","QPLUserFlow","WABase64","WAHashStringToNumber","WALogger","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","cr:14165","gkx","handleRestoreMessagesGraphQLResponse","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] graphQL point restore error ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is not complete - cannot proceed with graphQL restore"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] backup_id is null during graphQL restore"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message range info is null - cannot proceed with graphQL restore"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] server side exception during graphql restore - ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] GQL worker point restore query returned null for message response"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory params of client state are null"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No client state found - unable to restore"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No client state found - unable to restore"]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Calling EBLS without EBLS being available for message point query"]);t=function(){return a};return a}var u=h!==void 0?h:h=b("EBMessagePointQueryWithPersistenceQuery.graphql");function a(a){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e,f=a.jid,g=a.messageId,h=a.sortOrderMs,v=a.source,w=a.threadId;a=a.traceId;if(!d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql");a=a!=null?a:d("MAWMainTraceUtils").createTraceId();var x=d("WAHashStringToNumber").hashStringToNumber(a),y=c("qpl")._(521474469,"2612");c("QPLUserFlow").start(y,{annotations:{bool:{mainThreadRestore:!1,workerThreadRestore:!0},"int":{source:(e=v)!=null?e:c("LSMEBTaskCreationSource").UNKNOWN}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestorePoint(v,a,"GQL_WORKER",!0);try{var z;if(b("cr:14165")==null){d("WALogger").ERROR(t());c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EBLS_NOT_INITIALIZED,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.EBLS_NOT_INITIALIZED}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"ebls_not_initialized");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("ebls-not-intialized")}c("QPLUserFlow").addPoint(y,"before_ebls_initialization",{instanceKey:x});yield b("cr:14165").genLSClient();c("QPLUserFlow").addPoint(y,"after_ebls_initialization",{instanceKey:x});e=(yield b("cr:14165").getLSStorage());var A=c("gkx")("3713");A=A?yield d("EBIsEbEnabled").isEbEnabledLS(e.tables):void 0;if(c("gkx")("2489")){var B=d("MAWEncryptedBackupsPersistedDB").getEBLSDB();B=(yield d("EBSMHydrationUtils").loadEBdataToEphemeralRestore(B));var C=d("EBAPISharedUtils").getClientStateFromPersistedEBSM(B);B=d("EBAPISharedUtils").getAvailableEpochsFromPersistedEBSM(B);if(C===null){d("WALogger").ERROR(s());c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"no_client_state");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("no-client-state")}var D=A!=null?A:d("EBAPISharedUtils").isBackupTenancyAuthoritative(C);if(!D){c("QPLUserFlow").addPoint(y,"eb_not_enabled",{instanceKey:x});c("QPLUserFlow").endSuccess(y,{instanceKey:x});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"eb_not_enabled",traceId:a});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(a,!0);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.success");return d("WAResultOrError").makeResult()}D=d("EBAPISharedUtils").getDeviceAndKeyMetadata(C,B)}else{C=(yield d("MAWEncryptedBackupUtils").getBackupTenancy(e.tables));B=A!=null?A:C!=null&&(i||(i=d("I64"))).equal(C,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION));if(!B){c("QPLUserFlow").addPoint(y,"eb_not_enabled",{instanceKey:x});c("QPLUserFlow").endSuccess(y,{instanceKey:x});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"eb_not_enabled",traceId:a});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(a,!0);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.success");return d("WAResultOrError").makeResult()}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"lsdb_singleton_retrieved",traceId:a});c("QPLUserFlow").addPoint(y,"lsdb_singleton_retrieved",{instanceKey:x});D=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(e))}if(D==null){d("WALogger").ERROR(r());c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"no_client_state");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("no-client-state")}A=D;C=A.backupId;var E=A.device_id;B=A.locally_available_epochs;var F=A.mailboxRootKey;A=A.ocmfClientStateBlob;if(C==null||E==null||F==null||A==null){d("WALogger").ERROR(q());c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{device_id:(i||(i=d("I64"))).to_string((z=(z=D)==null?void 0:z.device_id)!=null?z:(i||(i=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:a});c("QPLUserFlow").addPoint(y,"client_state_retrieved",{data:{string:{device_id:i.to_string((D=(z=D)==null?void 0:z.device_id)!=null?D:(i||(i=d("I64"))).zero)}},instanceKey:x});z=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"app_id_retrieved",traceId:a});c("QPLUserFlow").addPoint(y,"app_id_retrieved",{instanceKey:x});D={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(w),site:"www",tam_thread_subtype:0},success:babelHelpers["extends"]({device_context:{device_id:i.to_string(E),locally_available_epochs:B,raw_tokens:{mailbox_root_key:d("WABase64").encodeB64(F),ocmf_client_state_blob:d("WABase64").encodeB64(A)}},message_id:g},h!=null?{reference_timestamp:h}:{})};d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"graphql_query_start",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:x});yield d("WorkerRelayNetwork").createWorkerNetworkExecute();F=(yield d("WorkerRelay").createWorkerQuery(u,{app_id:String((B=z)!=null?B:"0"),restore_payload_string:JSON.stringify(D),restore_type:"POINT_QUERY_RESTORE"}));d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"graphql_query_end",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,{instanceKey:x});if(F==null||(F==null?void 0:(A=F.viewer)==null?void 0:(g=A.encrypted_backup)==null?void 0:g.mailbox)==null){c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"gql_point_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}A=F==null?void 0:(z=F.viewer)==null?void 0:(B=z.encrypted_backup)==null?void 0:(D=B.mailbox)==null?void 0:D.messages_point_restore;if(A==null){d("WALogger").ERROR(p());c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"gql_point_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}g=A;if((g==null?void 0:g.encrypted_messages)==null){c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}},instanceKey:x});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"null_messages",traceId:a});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}F=g.backup_id;z=g.encrypted_messages;B=g.epoch_derivation_set;D=g.exception_string;A=g.message_range_info;g=g.should_delete_mailbox;if(D!=null){d("WALogger").ERROR(o(),D);g===!0&&(c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,{instanceKey:x}),yield e.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(j||(j=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:E})},"readwrite"),d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"delete_mailbox",traceId:a}));c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:D}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:D}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("server-side-exception")}d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"derive_and_store_epochs_start",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,{instanceKey:x});c("QPLUserFlow").addAnnotations(y,{bool:{hasEpochs:B!=null&&B.epoch_edges.length>0}},{instanceKey:x});yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(B,e,E,a,!0);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"derive_and_store_epochs_end",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,{instanceKey:x});z.length===0&&(c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE,{instanceKey:x}),d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"no_messages",traceId:a}));if(A==null){d("WALogger").ERROR(n());c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"missing_message_range_info");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}F==null&&(d("WALogger").WARN(m()),c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,{instanceKey:x}),d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"backup_id_null",traceId:a}));g=A.has_more_after;D=A.has_more_before;B=A.next_message_timestamp_ms_after;A=A.next_message_timestamp_ms_before;if(D==null||g==null||B==null||A==null){d("WALogger").ERROR(l());c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}z=d("handleRestoreMessagesGraphQLResponse").processMessageArray(z,F!=null?F:(i||(i=d("I64"))).to_string(C),y,x);var G=z.encryptedLSEchoMessages,H=z.encryptedMessagesWithProtobufs;if(H.length===0){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_echo_start",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START,{instanceKey:x});F=(yield e.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:w,encryptedMessages:c("LSVec").ofArray(G)})},"readwrite"));d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_echo_end",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END,{instanceKey:x});C=F[0];if(C!=null){z=c("LSVec").toArray(C).map(function(a){return d("LSShape").toRecord(a).value});c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:f,echoMessages:c("LSVec").ofArray(z),hasMoreAfter:g,hasMoreBefore:D,isPointQuery:!0,nextMessageTimestampMsAfter:(i||(i=d("I64"))).of_string(B),nextMessageTimestampMsBefore:i.of_string(A),referenceTimestamp:h!=null?(i||(i=d("I64"))).to_string(h):void 0,requestId:a,taskSource:(j||(j=d("LSIntEnum"))).ofNumber((F=v)!=null?F:c("LSMEBTaskCreationSource").UNKNOWN),threadId:w}}]}))}}else{d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_protobuf_start",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START,{instanceKey:x});C=(yield e.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:w,encryptedMessagesWithProtobufs:c("LSVec").ofArray(H)})},"readwrite"));d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypt_messages_protobuf_end",traceId:a});c("QPLUserFlow").addPoint(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END,{instanceKey:x});if(C[0]!=null){z=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(C[0]);c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:f,decryptedMessagesProtobufs:z,hasMoreAfter:g,hasMoreBefore:D,isPointQuery:!0,nextMessageTimestampMsAfter:(i||(i=d("I64"))).of_string(B),nextMessageTimestampMsBefore:i.of_string(A),referenceTimestamp:h!=null?(i||(i=d("I64"))).to_string(h):void 0,requestId:a,taskSource:(j||(j=d("LSIntEnum"))).ofNumber((F=v)!=null?F:c("LSMEBTaskCreationSource").UNKNOWN),threadId:w}}]}))}else{c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPTED_PROTOBUFS_NULL,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPTED_PROTOBUFS_NULL}},instanceKey:x});d("MAWEBRestoreTrackingUtils").addQPLRestorePointWorker({pointName:"decrypted_protobufs_null",traceId:a});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"decrypted_protobufs_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}}c("QPLUserFlow").endSuccess(y,{annotations:{bool:{isEcho:H.length===0,isProtobuf:H.length>0}},instanceKey:x});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.success");return d("WAResultOrError").makeResult()}catch(b){d("WALogger").ERROR(k(),b);c("QPLUserFlow").endFailure(y,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(e=b.stack)!=null?e:""}},error:b,instanceKey:x});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(a,!0,"gql_point_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.point.gql.error");return d("WAResultOrError").makeError("runtime-error",b)}});return v.apply(this,arguments)}g.pointRestoreQuery=u;g.messagePointQueryWithPersistence=a}),98);
__d("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="9305752246212228"}),null);
__d("EBMessageRangeQueryWithPersistenceQuery.graphql",["EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessageRangeQueryWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessageRangeQueryWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessageRangeQueryWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EchoMessageDecryptor",["CryptoUtils","I64","LSAuthorityLevel","LSIntEnum","MEBEncryptionVersion","Promise","ReQL","WACryptoUtils","WALogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No backup id provided"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]);m=function(){return a};return a}a=function(){function a(){}var e=a.prototype;e.decrypt=function(a,e,f){var g=this;f=f.map(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var f=(yield g.getEpochKeysByID(a,b));if(f.length===0){d("WALogger").ERROR(m());return{otid:b.otid,value:null}}f=(yield d("CryptoUtils").deriveMessageSymmetricKey(f[0].epochAnonIdBlob,f[0].epochRootKeyBlob,(f=b.encryption_version)!=null?f:c("MEBEncryptionVersion").UNKNOWN,e));if(f==null||f.length===0){d("WALogger").ERROR(l());return{otid:b.otid,value:null}}f=(yield d("CryptoUtils").symmetricEncryptionCreateDecryptedString(f[0],new TextEncoder().encode([d("CryptoUtils").MESSAGE_ENCYPTION_AAD,e].join(d("CryptoUtils").STRING_JOIN_SEPARATOR)).buffer,b.value));return{otid:b.otid,value:f}});return function(a){return f.apply(this,arguments)}}());return(j||(j=b("Promise"))).all(f)};e.getEpochs=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){if(b==null){d("WALogger").ERROR(k());return[]}a=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_epochs)));return a.filter(function(a){return(h||(h=d("I64"))).equal(a.authorityLevel,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))&&(h||(h=d("I64"))).equal(a.backupId,(h||(h=d("I64"))).of_float(b))&&e.equals(a[e.key])})});function e(b,c,d){return a.apply(this,arguments)}return e}();e.getEpochKeysByID=function(a,b){var c=b.epoch_id;return c!=null?this.getEpochs(a,b.backup_id,{equals:function(a){return a instanceof ArrayBuffer?!1:(h||(h=d("I64"))).equal(c,a)},key:"epochId",value:c}):this.getEpochs(a,b.backup_id,{equals:function(a){return a instanceof ArrayBuffer?d("WACryptoUtils").arrayBuffersEqual(b.epoch_anon_id,a):!1},key:"epochAnonIdBlob",value:b.epoch_anon_id})};return a}();g.EchoMessageDecryptor=a}),98);
__d("EBMessageRangeQueryWithPersistence",["EBAPIQPLPoints","EBAPISharedUtils","EBAPIWorkerCheck","EBMessageRangeQueryWithPersistenceQuery.graphql","EchoMessageDecryptor","I64","LSDatabaseSingleton","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSDeleteAndReenrollDeviceStateStoredProcedure","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWEBRestoreTrackingUtils","MAWJobDefinitions","MAWMiActGetThreadLifecycleState","MAWMiActThreadLifecycleState","QPLUserFlow","WABase64","WAHashStringToNumber","WAJids","WAResultOrError","WATagsLogger","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","gkx","handleRestoreMessagesGraphQLResponse","justknobx","promiseDone","qex","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["graphQL range restore error ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[protobuf-only] decryptMessageProtobufs failed with an error"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[echo-only][echo] decryptMessageEcho failed with an error."]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with error: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][protobuf] decryptMessageProtobufs failed with an error."]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with error: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["[mixed][echo] decryptMessageEcho failed with an error."]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery echo: "," protobuf: "," nonLsEcho: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["message range info is not complete - cannot proceed with graphQL restore"]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["backup_id is null during graphQL restore"]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["message range info is null - cannot proceed with graphQL restore"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["server side exception during graphql restore - ",""]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] messageRangeQuery graphQL response messages: ",""]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["GQL worker range restore query returned null for message response"]);A=function(){return a};return a}function aa(){var a=babelHelpers.taggedTemplateLiteralLoose(["mandatory params of client state are null"]);aa=function(){return a};return a}function ba(){var a=babelHelpers.taggedTemplateLiteralLoose(["No client state found - unable to restore"]);ba=function(){return a};return a}function ca(){var a=babelHelpers.taggedTemplateLiteralLoose(["[","] Issuing messageRangeQuery with args: ",""]);ca=function(){return a};return a}var da=c("requireDeferred")("LSEBUnifiedRestoreUtils").__setRef("EBMessageRangeQueryWithPersistence"),ea=c("requireDeferred")("LSRestoreEchoBlobs.nop").__setRef("EBMessageRangeQueryWithPersistence"),fa=c("requireDeferred")("LSRestoreProtobufs.nop").__setRef("EBMessageRangeQueryWithPersistence"),B=d("WATagsLogger").TAGS(["labyrinth_web","EBMessageRangeQueryWithPersistence"]),ga=h!==void 0?h:h=b("EBMessageRangeQueryWithPersistenceQuery.graphql");function a(a){return C.apply(this,arguments)}function C(){C=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,g=a.direction,h=a.includeOffset;h=h===void 0?!1:h;var C=a.numMessages,D=a.sortOrderMs,E=a.source,F=a.traceId;if(d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");var G=c("qex")._("3429")||c("gkx")("11008");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql");var H=d("WAHashStringToNumber").hashStringToNumber(F),I=c("qpl")._(521471755,"2586");try{var J,K;c("QPLUserFlow").start(I,{annotations:{bool:{mainThreadRestore:!0,workerThreadRestore:!1},"int":{num_messages_requested:C,source:(J=E)!=null?J:c("LSMEBTaskCreationSource").UNKNOWN},string:{request_args:JSON.stringify(a)}},instanceKey:H,timeoutInMs:c("justknobx")._("2950")});B.LOG(ca(),F,JSON.stringify(a));d("MAWEBRestoreTrackingUtils").markEBRestorePaginated(E,F,"GQL_MAIN_THREAD");var L=(yield (i||(i=d("LSDatabaseSingleton"))).getLSDatabaseSingletonPromiseOrValue());d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"lsdb_singleton_retrieved",traceId:F,type:"none"});c("QPLUserFlow").addPoint(I,"lsdb_singleton_retrieved",{instanceKey:H});var M;yield L.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;M=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(L,a));d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{device_id:(j||(j=d("I64"))).to_string((b=(b=M)==null?void 0:b.device_id)!=null?b:(j||(j=d("I64"))).zero)}},pointName:"client_state_retrieved",traceId:F});c("QPLUserFlow").addPoint(I,"client_state_retrieved",{data:{string:{device_id:j.to_string((b=(b=M)==null?void 0:b.device_id)!=null?b:(j||(j=d("I64"))).zero)}},instanceKey:H});b=(yield d("MAWMiActGetThreadLifecycleState").getThreadLifecycleStateByJid(a,j.of_string(d("WAJids").threadIdForChatJid(e)),"GQL_range_restore_eb_api_call"));if(b.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MAPPING_ROW||b.type===d("MAWMiActThreadLifecycleState").MiActThreadStatesEnum.JID_MISSING_MI_THREAD){d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:b.type}},pointName:"chat_jid_not_found_in_act_mapping_table",traceId:F});c("QPLUserFlow").addPoint(I,"chat_jid_not_found_in_act_mapping_table",{instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(F,!1);c("QPLUserFlow").endSuccess(I,{instanceKey:H});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.thread.missing.error");return d("WAResultOrError").makeError("thread-not-found-in-mi-act-mapping-table")}else d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{string:{thread_state_by_jid:b.type}},pointName:"chat_jid_exists_in_act_mapping_table",traceId:F}),c("QPLUserFlow").addPoint(I,"chat_jid_exists_in_act_mapping_table",{instanceKey:H})});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":200");if(M==null){B.ERROR(ba());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("no-client-state")}J=M;a=J.backupId;var N=J.device_id,O=J.locally_available_epochs,P=J.mailboxRootKey;J=J.ocmfClientStateBlob;if(a==null||N==null||P==null||J==null){B.ERROR(aa());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"client_state_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-client-state")}var Q=d("MAWCurrentUser").getAppID();d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"app_id_retrieved",traceId:F,type:"none"});c("QPLUserFlow").addPoint(I,"app_id_retrieved",{instanceKey:H});var R=d("WAJids").threadIdForChatJid(e);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"converted_chatjid_to_threadid",traceId:F,type:"none"});c("QPLUserFlow").addPoint(I,"converted_chatjid_to_threadid",{instanceKey:H});g=g==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;O={restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(R),site:"www",tam_thread_subtype:0},success:babelHelpers["extends"]({device_context:{device_id:(j||(j=d("I64"))).to_string(N),locally_available_epochs:O,raw_tokens:{mailbox_root_key:d("WABase64").encodeB64(P),ocmf_client_state_blob:d("WABase64").encodeB64(J)}},direction:g,include_offset:h,query_num_messages:C,server_thread_key:R},D!=null?{reference_timestamp:D}:{})};c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:H});d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_start",traceId:F,type:"none"});var S;try{yield d("WorkerRelayNetwork").createWorkerNetworkExecute();S=(yield d("WorkerRelay").createWorkerQuery(ga,{app_id:String((P=Q)!=null?P:"0"),restore_payload_string:JSON.stringify(O),restore_type:"RANGE_QUERY_RESTORE"}));c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,{instanceKey:H});d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"graphql_query_end",traceId:F,type:"none"})}catch(a){c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_EXCEPTION,errorStackTrace:(J=a.stack)!=null?J:""}},instanceKey:H});return d("WAResultOrError").makeError("invalid-graphql-response")}if(S==null||((g=S)==null?void 0:(h=g.viewer)==null?void 0:(C=h.encrypted_backup)==null?void 0:C.mailbox)==null){c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}g=(Q=S)==null?void 0:(P=Q.viewer)==null?void 0:(O=P.encrypted_backup)==null?void 0:(J=O.mailbox)==null?void 0:J.messages;if(g==null){B.ERROR(A());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}h=g;if((h==null?void 0:h.encrypted_messages)==null){c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NULL_MESSAGES}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"null_messages");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("invalid-graphql-response")}C=h.backup_id;Q=h.encrypted_messages;P=h.epoch_derivation_set;O=h.exception_string;J=h.message_range_info;g=h.should_delete_mailbox;var T=h.thread_not_found;c("QPLUserFlow").addAnnotations(I,{bool:{should_delete_mailbox:(K=g)!=null?K:!1},"int":{response_messages:Q.length},string:{message_range_info:JSON.stringify(J)}},{instanceKey:H});B.LOG(z(),F,JSON.stringify(h));if(O!=null){B.ERROR(y(),O);if(T!=null&&T){c("QPLUserFlow").addPoint(I,"thread_not_found_on_server",{instanceKey:H});d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"thread_not_found_on_server",traceId:F,type:"none"});c("QPLUserFlow").endSuccess(I,{instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreSuccess(F,!1);return d("WAResultOrError").makeError("thread-not-found-on-server")}g===!0&&(c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,{instanceKey:H}),yield L.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(k||(k=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:N})},"readwrite",void 0,void 0,f.id+":566"),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"delete_mailbox",traceId:F,type:"none"}));c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:O}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{exception:O}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("server-side-exception")}c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,{instanceKey:H});yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(P,L,N,F);c("QPLUserFlow").addAnnotations(I,{bool:{hasEpochs:P!=null&&P.epoch_edges.length>0}},{instanceKey:H});c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,{instanceKey:H});Q.length===0&&(c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_MESSAGES_TO_RESTORE,{instanceKey:H}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"no_messages",traceId:F,type:"none"}));if(J==null){B.ERROR(x());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO);d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}C==null&&(B.WARN(w()),c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,{instanceKey:H}),d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"backup_id_null",traceId:F,type:"none"}));var U=J.has_more_after,V=J.has_more_before,W=J.next_message_timestamp_ms_after,X=J.next_message_timestamp_ms_before;if(V==null||U==null||W==null||X==null){B.ERROR(v());c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"message_range_info_null");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("missing-message-range-info")}K=d("handleRestoreMessagesGraphQLResponse").processMessageArray(Q,C!=null?C:(j||(j=d("I64"))).to_string(a),I,H);var Y=K.encryptedLSEchoMessages,Z=K.encryptedMessagesWithProtobufs;h=K.encryptedNonLSEchoMessages;B.LOG(u(),F,Y.length,Z.length,h.length);T="none";if(Y.length>0&&Z.length>0){T="mixed";c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RESTORING_MIXED_ECHO_PROTOBUF_PAYLOAD,{instanceKey:H});Q.length!==Y.length+Z.length&&c("QPLUserFlow").addPoint(I,"mixed_restore_payload_echo_and_protobuf_count_mismatch",{instanceKey:H});c("QPLUserFlow").addAnnotations(I,{"int":{echoMessagesPayloadSize:Y.length,protobufMessagesPayloadSize:Z.length,totalRestorePayloadSize:Y.length+Z.length}},{instanceKey:H});c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_START,{instanceKey:H});g=(yield L.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessages:c("LSVec").ofArray(Y)})),e=b[0];b=b[1];if(b!=null){b=d("LSShape").toRecord(b);B.ERROR(t());B.WARN(s(),b.error_message);c("QPLUserFlow").endFailure(I,"ECHO_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"ECHO_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}b=(yield c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessagesWithProtobufs:c("LSVec").ofArray(Z)}));a=b[0];b=b[1];if(b!=null){b=d("LSShape").toRecord(b);B.ERROR(r());B.WARN(q(),b.error_message);c("QPLUserFlow").endFailure(I,"PROTOBUF_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"PROTOBUF_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:b.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}return{decryptedEchoMsgs:e,decryptedProtobufMsgs:a}});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":802"));O=g.decryptedEchoMsgs;var ia=g.decryptedProtobufMsgs;c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_AND_PROTOBUF_END,{instanceKey:H});var $;O!=null&&($=c("LSVec").toArray(O).map(function(a){return d("LSShape").toRecord(a).value}));if(c("gkx")("9385")){yield ha((P=$)!=null?P:[],h,R,L,F,H)}c("promiseDone")(da.load().then(function(a){return a.echoProtobufConsolidatedRestoreHelper(R,(a=ia)!=null?a:c("LSVec").ofArray([]),V,(j||(j=d("I64"))).of_string(X),U,j.of_string(W),!1,F,D,void 0,c("LSVec").ofArray($),(k||(k=d("LSIntEnum"))).ofNumber((a=E)!=null?a:c("LSMEBTaskCreationSource").UNKNOWN),e,!0)}))}else if(Z.length===0){T="echo";c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START,{instanceKey:H});J=(yield L.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessages:c("LSVec").ofArray(Y)})},"readwrite",void 0,void 0,f.id+":949"));C=J[0];a=J[1];if(a!=null){K=d("LSShape").toRecord(a);B.ERROR(p());B.WARN(o(),K.error_message);c("QPLUserFlow").endFailure(I,"ECHO_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:K.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"ECHO_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:K.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("echo-decryption-failure")}c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END,{instanceKey:H});if(C!=null){var ja=c("LSVec").toArray(C).map(function(a){return d("LSShape").toRecord(a).value});if(c("gkx")("9385")){yield ha((Q=ja)!=null?Q:[],h,R,L,F,H)}c("promiseDone")(ea.load().then(function(a){return L.runInTransaction(function(b){return a(b,0,(j||(j=d("I64"))).zero,c("LSVec").ofArray(ja),V,j.of_string(X),U,j.of_string(W),!1,R,F,D,(k||(k=d("LSIntEnum"))).ofNumber((b=E)!=null?b:c("LSMEBTaskCreationSource").UNKNOWN),e)},"readwrite",void 0,void 0,f.id+":1018")}))}}else{T="protobuf";c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START,{instanceKey:H});g=(yield L.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:R,encryptedMessagesWithProtobufs:c("LSVec").ofArray(Z)})},"readwrite",void 0,void 0,f.id+":1051"));var ka=g[0];O=g[1];if(O!=null){P=d("LSShape").toRecord(O);B.ERROR(n());B.WARN(m(),P.error_message);c("QPLUserFlow").endFailure(I,"PROTOBUF_DECRYPTION_FAILURE",{annotations:{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:P.error_message}},instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"PROTOBUF_DECRYPTION_FAILURE",{bool:{eblsDataFlowExperimentsRunning:G},string:{error_description:P.error_message}});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("protobuf-decryption-failure")}c("QPLUserFlow").addPoint(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END,{instanceKey:H});c("promiseDone")(fa.load().then(function(a){return L.runInTransaction(function(b){return a(b,0,R,(b=ka)!=null?b:c("LSVec").ofArray([]),V,(j||(j=d("I64"))).of_string(X),U,j.of_string(W),!1,F,D,void 0,c("LSVec").ofArray([]),(k||(k=d("LSIntEnum"))).ofNumber((b=E)!=null?b:c("LSMEBTaskCreationSource").UNKNOWN),e)},"readwrite",void 0,void 0,f.id+":1103")}))}c("QPLUserFlow").endSuccess(I,{annotations:{string:{restoreType:T}},instanceKey:H});d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.success");return d("WAResultOrError").makeResult()}catch(a){B.ERROR(l(),a);c("QPLUserFlow").endFailure(I,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,errorStackTrace:(J=a.stack)!=null?J:""}},error:a,instanceKey:H});d("MAWEBRestoreTrackingUtils").markEBRestoreFail(F,!1,"gql_range_restore_exception");d("EBAPISharedUtils").bumpOdsRestoreKey("restore.request.paginated.gql.error");return d("WAResultOrError").makeError("runtime-error",a)}});return C.apply(this,arguments)}function ha(a,b,c,d,e,f){return D.apply(this,arguments)}function D(){D=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h){var i=c("qpl")._(521471755,"2586");f=(yield new(d("EchoMessageDecryptor").EchoMessageDecryptor)().decrypt(f,e,b));e=E(f,a);d("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotations({annotations:{bool:{isMatch:e}},pointName:"ls_and_non_ls_echo_msg_decryption_response_comparison",traceId:g});c("QPLUserFlow").addAnnotations(i,{bool:{does_ls_and_non_ls_echo_msg_decryption_match:e}},{instanceKey:h})});return D.apply(this,arguments)}function E(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c].value!==b[c])return!1;return!0}g.query=ga;g.messageRangeQueryWithPersistence=a}),98);